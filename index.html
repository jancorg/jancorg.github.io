
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>I left my leg in Jaglan Beta</title>
  <meta name="author" content="jancorg">

  
  <meta name="description" content="Reading the code is the best documentation place at the end, and despites the fact that it is time consuming and sometimes hard to understand, it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jancorg.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="I left my leg in Jaglan Beta" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-57753907-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">I left my leg in Jaglan Beta</a></h1>
  
    <h2>I&#8217;d far rather be happy than right any day.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="jancorg.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/21/docker-code-curiosities/">Docker Code Curiosities</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-21T08:17:51+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>8:17 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Reading the code is the best documentation place at the end, and despites the fact that it is time consuming and sometimes hard to understand, it could make you happier sometimes.</p>

<p>This post is about the unrelated things I found (for now) in docker code.</p>

<h3>The meaning of life</h3>

<p>Given the name of the blog, this one did not scape to my eyes&hellip;</p>

<figure class='code'><figcaption><span>meaning_of_life</span><a href='https://github.com/docker/docker/blob/master/engine/streams_test.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">TestOutputAddEnv</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">input</span> <span class="o">:=</span> <span class="s">&quot;{\&quot;foo\&quot;: \&quot;bar\&quot;, \&quot;answer_to_life_the_universe_and_everything\&quot;: 42}&quot;</span>
</span><span class='line'>  <span class="nx">o</span> <span class="o">:=</span> <span class="nx">NewOutput</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">AddEnv</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">o</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
</span><span class='line'>  <span class="nx">o</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">);</span> <span class="nx">v</span> <span class="o">!=</span> <span class="s">&quot;bar&quot;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected %v, got %v&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">GetInt</span><span class="p">(</span><span class="s">&quot;answer_to_life_the_universe_and_everything&quot;</span><span class="p">);</span> <span class="nx">v</span> <span class="o">!=</span> <span class="mi">42</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected %v, got %v&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;this-value-doesnt-exist&quot;</span><span class="p">);</span> <span class="nx">v</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Expected %v, got %v&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember, don&rsquo;t forget your towel!</p>

<h3>Names generator</h3>

<p>I enjoyed this wink, I mean, the whole file. It is worth to read it all, since all the names are quoted and this quick reference could wake up some interest about someone.</p>

<figure class='code'><figcaption><span>things_clear</span><a href='https://github.com/docker/docker/blob/master/pkg/namesgenerator/names-generator.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">begin</span><span class="p">:</span>
</span><span class='line'>  <span class="nx">name</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s_%s&quot;</span><span class="p">,</span> <span class="nx">left</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">left</span><span class="p">))],</span> <span class="nx">right</span><span class="p">[</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">right</span><span class="p">))])</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">name</span> <span class="o">==</span> <span class="s">&quot;boring_wozniak&quot;</span> <span class="cm">/* Steve Wozniak is not boring */</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">goto</span> <span class="nx">begin</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have to say I agree.</p>

<p>At least they are not as hard as the <a href="http://www.vidarholen.net/contents/wordcount/">ones</a> in linux code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/05/linux-kernel-namespaces-pt-i/">Linux Kernel Namespaces Pt I</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-05T20:03:42+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:03 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Namespaces are used to provide a process or a group of processes with the idea of being the only process or group of processes in the system.</p>

<p>They are a way to detach processes from a specific kernel layer assigning them to a new one. Or in other words, they are indirections layers for global resources.</p>

<p>Lets imagine this as an extension to classical <code>chroot()</code> syscall. When setting a new root calling chroot, kernel was isolating new branch from existing one, and thus creating a new namespace for the process.</p>

<blockquote><p>Namespaces now provide the basis for a complete lightweight virtualization system, in the form of containers.</p></blockquote>

<p>Currently, linux support following namespaces</p>

<table>
<thead>
<tr>
<th>NameSpace </th>
<th style="text-align:center;"> from Kernel </th>
<th> Descrition</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTS       </td>
<td style="text-align:center;"> 2.6.19      </td>
<td> domain and hostname</td>
</tr>
<tr>
<td>IPC       </td>
<td style="text-align:center;"> 2.6.19      </td>
<td> queues, semaphores, and shared memmory</td>
</tr>
<tr>
<td>PID       </td>
<td style="text-align:center;"> 2.6.19      </td>
<td> pid</td>
</tr>
<tr>
<td>NS        </td>
<td style="text-align:center;"> 2.4.19      </td>
<td> Filesystems</td>
</tr>
<tr>
<td>NET       </td>
<td style="text-align:center;"> 2.4.24      </td>
<td> IP, routes, network devices&hellip;</td>
</tr>
<tr>
<td>USER      </td>
<td style="text-align:center;"> 3.8         </td>
<td> Uid, Guid,&hellip;</td>
</tr>
</tbody>
</table>


<p><br>
I let individual namespaces explanations as simple as this, or in other words, for another day.</p>

<h2>Namespaces API</h2>

<p>In Linux kernel there are not distinction between process and threads implementions, threads are just light weight processes. Threads are also created by calling <code>clone()</code> but with different arguments (<code>CLONE_VM</code> mainly). From the kernel point of view, a process/thread is a task.</p>

<p>Namespaces can be nested. Limit for nesting namespaces is 32.</p>

<figure class='code'><figcaption><span>nest_limit</span><a href='https://github.com/torvalds/linux/blob/87c31b39abcb6fb6bd7d111200c9627a594bf6a9/kernel/user_namespace.c'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">parent_ns</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="n">EUSERS</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Structs</h3>

<p>Next are most important structs parts used by namespaces API.</p>

<figure class='code'><figcaption><span>task_struct</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/sched.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">task_struct</span> <span class="p">{</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="cm">/* process credentials */</span>
</span><span class='line'>  <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span> <span class="cm">/* effective (overridable) subjective task</span>
</span><span class='line'><span class="cm">                  * credentials (COW) */</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="cm">/* namespaces */</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">nsproxy</span>          <span class="o">*</span><span class="n">nsproxy</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>nsproxy</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/nsproxy.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">nsproxy</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">atomic_t</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">uts_namespace</span> <span class="o">*</span><span class="n">uts_ns</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ipc_ns</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">mnt_namespace</span> <span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">pid_ns_for_children</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">net</span>           <span class="o">*</span><span class="n">net_ns</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>credentials</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/cred.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">cred</span> <span class="p">{</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span> <span class="cm">/* user_ns the caps and keyrings are relative to. */</span>
</span><span class='line'><span class="p">[...]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>user_namespace</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/user_namespace.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">user_namespace</span> <span class="p">{</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">ns_common</span>      <span class="n">ns</span><span class="p">;</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h3>System calls</h3>

<p>Namespaces can be created or modified by <code>clone()</code>, <code>unshare()</code> and <code>setns()</code> system calls. All of them are not POSIX system calls, so only available in linux.</p>

<p><code>clone()</code> system call is more specific than <code>fork()</code> or <code>vfork()</code> system calls.  They are alike, because they are implemented by calling <code>do_fork()</code> function with different flags and args.</p>

<figure class='code'><figcaption><span>fork_linux</span><a href='https://github.com/torvalds/linux/blob/master/kernel/fork.c'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SYSCALL_DEFINE0</span><span class="p">(</span><span class="n">fork</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">do_fork</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="n">SYSCALL_DEFINE0</span><span class="p">(</span><span class="n">vfork</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">do_fork</span><span class="p">(</span><span class="n">CLONE_VFORK</span> <span class="o">|</span> <span class="n">CLONE_VM</span> <span class="o">|</span> <span class="n">SIGCHLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>          <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">clone_flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">newsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">parent_tidptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">child_tidptr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">tls_val</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">do_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span> <span class="n">newsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_tidptr</span><span class="p">,</span> <span class="n">child_tidptr</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p><code>copy_process()</code> function in <code>do_fork()</code> calls <code>copy_namespaces()</code>. In case any namespace flags present, it just uses parent namespaces. (<code>fork()</code>, <code>vfork()</code>  behavior)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CLONE_NEWNS</span> <span class="o">|</span> <span class="n">CLONE_NEWUTS</span> <span class="o">|</span> <span class="n">CLONE_NEWIPC</span> <span class="o">|</span> <span class="n">CLONE_NEWPID</span> <span class="o">|</span> <span class="n">CLONE_NEWNET</span><span class="p">))))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">get_nsproxy</span><span class="p">(</span><span class="n">old_ns</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">get_nsproxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nsproxy</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If any is present, it creates a new nsproxy struct and copies all namespaces.</p>

<figure class='code'><figcaption><span>create_new_namespaces</span><a href='https://github.com/torvalds/linux/blob/603ba7e41bf5d405aba22294af5d075d8898176d/kernel/nsproxy.c'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">new_nsp</span> <span class="o">=</span> <span class="n">create_nsproxy</span><span class="p">();</span>
</span><span class='line'><span class="n">new_nsp</span><span class="o">-&gt;</span><span class="n">mnt_ns</span> <span class="o">=</span> <span class="n">copy_mnt_ns</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">mnt_ns</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">new_fs</span><span class="p">);</span>
</span><span class='line'><span class="n">new_nsp</span><span class="o">-&gt;</span><span class="n">uts_ns</span> <span class="o">=</span> <span class="n">copy_utsname</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">uts_ns</span><span class="p">);</span>
</span><span class='line'><span class="n">new_nsp</span><span class="o">-&gt;</span><span class="n">ipc_ns</span> <span class="o">=</span> <span class="n">copy_ipcs</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">);</span>
</span><span class='line'><span class="n">new_nsp</span><span class="o">-&gt;</span><span class="n">pid_ns_for_children</span> <span class="o">=</span> <span class="n">copy_pid_ns</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">pid_ns_for_children</span><span class="p">);</span>
</span><span class='line'><span class="n">new_nsp</span><span class="o">-&gt;</span><span class="n">net_ns</span> <span class="o">=</span> <span class="n">copy_net_ns</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">,</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">new_nsp</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Child process is responsible for changing any namespace data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sethostname</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">hostname</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>unshare()</code> system call allows a process to disassociate parts of its execution context that are currently being shared with other processes.</p>

<p>It allows to control shared execution context without creating a new process.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">unshare</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">unshare_flags</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">err</span> <span class="o">=</span> <span class="n">unshare_fs</span><span class="p">(</span><span class="n">unshare_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fs</span><span class="p">);</span>
</span><span class='line'>  <span class="n">err</span> <span class="o">=</span> <span class="n">unshare_fd</span><span class="p">(</span><span class="n">unshare_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_fd</span><span class="p">);</span>
</span><span class='line'>  <span class="n">err</span> <span class="o">=</span> <span class="n">unshare_userns</span><span class="p">(</span><span class="n">unshare_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_cred</span><span class="p">);</span>
</span><span class='line'>  <span class="n">err</span> <span class="o">=</span> <span class="n">unshare_nsproxy_namespaces</span><span class="p">(</span><span class="n">unshare_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_nsproxy</span><span class="p">,</span> <span class="n">new_cred</span><span class="p">,</span> <span class="n">new_fs</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Flags like <code>CLONE_NEW*</code> flags have same effect as they have in <code>clone()</code>. All others ones that <code>unshare()</code> accepts has reverse effect. Since they were copied in above <code>create_new_namespaces</code> example.</p>

<p>When a task ends, all namespaces they belong to that does not have any other process attached are cleaned. This means, mounts unmounted, network interfaced destroyed, etc.</p>

<figure class='code'><figcaption><span>put_nsproxy</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/nsproxy.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_nsproxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">nsproxy</span> <span class="o">*</span><span class="n">ns</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">free_nsproxy</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last API function to comment is <code>setns()</code> that simply allows a process to join an existing namespace.</p>

<figure class='code'><figcaption><span>setns</span><a href='https://github.com/torvalds/linux/blob/603ba7e41bf5d405aba22294af5d075d8898176d/kernel/nsproxy.c'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">setns</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">nstype</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">file</span> <span class="o">=</span> <span class="n">proc_ns_fget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>  <span class="n">ns</span> <span class="o">=</span> <span class="n">get_proc_ns</span><span class="p">(</span><span class="n">file_inode</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
</span><span class='line'>  <span class="n">new_nsproxy</span> <span class="o">=</span> <span class="n">create_new_namespaces</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tsk</span><span class="p">,</span> <span class="n">current_user_ns</span><span class="p">(),</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">fs</span><span class="p">);</span>
</span><span class='line'>  <span class="n">err</span> <span class="o">=</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">install</span><span class="p">(</span><span class="n">new_nsproxy</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">switch_task_namespaces</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">new_nsproxy</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>fd argument specifies the namespace to join. It is translated to a nscommon struct calling <code>get_proc_ns(file_inode(file))</code>. We will cover fds in next point.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">define</span> <span class="n">get_proc_ns</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ns_common</span> <span class="o">*</span><span class="p">)(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Namespaces in /proc</h2>

<p>Per process namespaces can be found under <code>/proc/$pid/ns</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ls -l /proc/<span class="nv">$$</span>/ns
</span><span class='line'>total 0
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 ipc -&gt; ipc:<span class="o">[</span>4026531839<span class="o">]</span>
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 mnt -&gt; mnt:<span class="o">[</span>4026531840<span class="o">]</span>
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 net -&gt; net:<span class="o">[</span>4026531962<span class="o">]</span>
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 pid -&gt; pid:<span class="o">[</span>4026531836<span class="o">]</span>
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 user -&gt; user:<span class="o">[</span>4026531837<span class="o">]</span>
</span><span class='line'>lrwxrwxrwx <span class="m">1</span> ubuntu ubuntu <span class="m">0</span> Jan  <span class="m">5</span> 21:12 uts -&gt; uts:<span class="o">[</span>4026531838<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each process namespace has an inode number, that corresponds with a namespace struct. If two tasks share same number, they belongs to same namespace. Inode for ns files in namespaces is not the same as <code>stat -c %i</code> shows. They are sym links.
For namespaces, like sockets or pipes inode number is shown in form <code>type:[inode]</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># for pid in 643 23681 32178 ; do readlink /proc/$pid/ns/mnt ; done</span>
</span><span class='line'>mnt:<span class="o">[</span>4026531840<span class="o">]</span>
</span><span class='line'>mnt:<span class="o">[</span>4026532430<span class="o">]</span>
</span><span class='line'>mnt:<span class="o">[</span>4026532430<span class="o">]</span>
</span><span class='line'><span class="c"># for pid in 643 23681 32178 ; do md5sum /proc/$pid/mounts ; done</span>
</span><span class='line'>8dddf7d919672a56849bb487840b94e0  /proc/643/mounts
</span><span class='line'>70159c37e8c8f16c61ceaa047ad9528a  /proc/23681/mounts
</span><span class='line'>70159c37e8c8f16c61ceaa047ad9528a  /proc/32178/mounts
</span><span class='line'><span class="c"># unshare -m /bin/bash </span>
</span><span class='line'><span class="c"># readlink /proc/$$/ns/mnt</span>
</span><span class='line'>mnt:<span class="o">[</span>4026532493<span class="o">]</span>
</span><span class='line'><span class="c"># for pid in  643 23681 32178; do stat -c %i /proc/$pid/ns/mnt ; done</span>
</span><span class='line'>1308868
</span><span class='line'>1308731
</span><span class='line'>1308686
</span></code></pre></td></tr></table></div></figure>


<p>Proc namespaces files are implemented through <code>proc_ns_operations</code> struct.</p>

<figure class='code'><figcaption><span>proc_ns_operations</span><a href='https://github.com/torvalds/linux/blob/master/include/linux/proc_ns.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">ns_common</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">put</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ns_common</span> <span class="o">*</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">install</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nsproxy</span> <span class="o">*</span><span class="n">nsproxy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ns_common</span> <span class="o">*</span><span class="n">ns</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">netns_operations</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">utsns_operations</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">ipcns_operations</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">pidns_operations</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">userns_operations</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ns_operations</span> <span class="n">mntns_operations</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><br>
There are availabe two commands that correspond to each system call (like most of the shell commands that are just called like any system call). <code>unshare</code> for <code>unshare()</code> and <code>nsenter</code> for <code>setns()</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/03/libcontainer-overview/">LibContainer Overview</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-03T18:14:14+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>6:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Libcontainer is now the default docker execution environment. It is driver (named native) and a library.</p>

<p>In other words, it is a replacement (since version 0.9) for formerly LXC execution environment (that can be easily brought back using <code>-e</code> switch).</p>

<p>This library is developed by docker.io, written in go and C/C++, in order to support a wider range of isolation technologies. It also can be used in python through python bindings.</p>

<p><img src="http://blog.docker.com/wp-content/uploads/2014/03/docker-execdriver-diagram.png" alt="docker execdriver" /></p>

<p>It is meant to be a cross-system abstraction layer being an attempt to standarize the way apps are packed up, delivered, and run in isolation.</p>

<p>Libcontainer as a stand alone project, makes possible to other game players adopting it. Google, parallels (openvz), redhat, ubuntu (lxc) are also contributing to this project.</p>

<p><img src="http://1.bp.blogspot.com/-sxNaakTEBlg/U6Bbtglx00I/AAAAAAAAAcw/xgreTVZP4F4/s1600/libcontainer+intro.png" alt="libcontainer_place" /></p>

<p>This way, container features available in linux kernel API are provided as a unique library in a consistent way. LibContainer addresses the problem of having an unique kernel API and several implementations. (call them, LXC, libvirt, lmctfy, &hellip;)</p>

<blockquote><p>Libcontainer enables containers to work with Linux namespaces, control groups, capabilities, AppArmor, security profiles, network interfaces and firewalling rules in a consistent and predictable way.</p></blockquote>

<p>Currently, docker can support these kernel features out-of-the-box, since it no longer depends on LXC.</p>

<p>It introduces a new container specification as we can see <a href="https://github.com/docker/libcontainer/blob/4940cee052ece5a8b2ea477699e7bb232de1e1f8/SPEC.md">here</a></p>

<blockquote><p> It includes namespaces, standard filesystem setup, a default Linux capability set, and information about resource reservations. It also has information about any populated environment settings for the processes running inside a container.</p></blockquote>

<p>Let`s see a little example of how it was replaced on docker code.</p>

<p><code>nsinit</code> and <code>nsenter</code> are the user-land tools that now are needed in order to replace <code>lxc-*</code> user-land tools.
<code>nsinit</code> is part of libcontainer package and it is meant to load a <a href="https://github.com/docker/libcontainer/blob/master/sample_configs/minimal.json">config json file</a>. It replaces <code>lxc-start</code>.</p>

<p><code>nsenter</code> replaces <code>lxc-attach</code> and it is not part of libcontainer package, but it is part of <code>util-linux</code> <a href="https://www.kernel.org/pub/linux/utils/util-linux/">package</a>.</p>

<p>When formerly we ran <code>docker run ...</code>, (by default) it called <code>lxc-start</code> to run the container.</p>

<figure class='code'><figcaption><span>lxc-start</span><a href='https://github.com/docker/docker/blob/17cacf3326edde6d177e12132f74fc0174bda1d2/daemon/execdriver/lxc/driver.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">params</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;lxc-start&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span><span class='line'>  <span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Currently, native execdriver is called.</p>

<figure class='code'><figcaption><span>native_exec_driver</span><a href='https://github.com/docker/docker/blob/17cacf3326edde6d177e12132f74fc0174bda1d2/daemon/execdriver/native/driver.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">driver</span><span class="p">)</span> <span class="nx">Run</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">execdriver</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">pipes</span> <span class="o">*</span><span class="nx">execdriver</span><span class="p">.</span><span class="nx">Pipes</span><span class="p">,</span> <span class="nx">startCallback</span> <span class="nx">execdriver</span><span class="p">.</span><span class="nx">StartCallback</span><span class="p">)</span> <span class="p">(</span><span class="nx">execdriver</span><span class="p">.</span><span class="nx">ExitStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// take the Command and populate the libcontainer.Config from it</span>
</span><span class='line'>  <span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">createContainer</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>native_syscalls</span><a href='https://github.com/docker/libcontainer/blob/1597c68f7b941fd97881155d7f077852e2914e7b/namespaces/utils.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">var</span> <span class="nx">namespaceInfo</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NamespaceType</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWNET</span><span class="p">:</span>  <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNET</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWNS</span><span class="p">:</span>   <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNS</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWUSER</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWIPC</span><span class="p">:</span>  <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWIPC</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWUTS</span><span class="p">:</span>  <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">libcontainer</span><span class="p">.</span><span class="nx">NEWPID</span><span class="p">:</span>  <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWPID</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>General go syscalls can be found <a href="http://golang.org/pkg/syscall/">here.</a>. These ones used above are Linux especific.</p>

<p>Master Libcontainer branch supports right now <a href="https://github.com/docker/docker/tree/master/daemon/execdriver">lxc and native</a> execdrivers. Hence it means that it can only used in linux for now.</p>

<figure class='code'><figcaption><span>supported_exec_drivers</span><a href='https://github.com/docker/docker/blob/master/daemon/execdriver/execdrivers/execdrivers.go'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">execdrivers</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="s">&quot;github.com/docker/docker/daemon/execdriver/lxc&quot;</span>
</span><span class='line'>  <span class="s">&quot;github.com/docker/docker/daemon/execdriver/native&quot;</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Other systems, like FreeBSD, implements &lsquo;containers&rsquo; using Jails. It is an older concept, and some people note that it could not be as sofisticated as linux one is.</p>

<p><a href="https://github.com/kzys/docker/commit/f8c4d49fda9eb7e35c88532c174fa8dca9d831ba">Here</a> is as an example of an execution driver in development for FreeBSD Jails. Well, it is an execution driver for FreeBSD, therefore not using libcontainer.</p>

<p>Unfortunately, FreeBSD (and others flavours) mention on docker &amp; libcontainer are only for go language.</p>

<p>A full list of OS level virtualization implementations can be found  on <a href="http://en.wikipedia.org/wiki/Operating_system%E2%80%93level_virtualization#Implementations">wikipedia</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/02/hubot-a-bot-for-automating-daily-tasks-or-anything-else/">Hubot: A Bot for Automating Daily Tasks or Anything Else</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-02T19:23:50+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>7:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Hubot is your company&rsquo;s robot. Install him in your company to dramatically improve and reduce employee efficiency.</p></blockquote>

<p>In other words, <a href="https://hubot.github.com/">hubot</a> is a chat bot crafted by github team that can run custom written scritps. This allow us to automatize any kind of tasks like merging branches, deploying releases, do monitoring queries, inform (it listen on a port), etc. It has a lot of adapters (where it reads from and writes to), even shell, so we can enjoy its company almost everywhere.</p>

<p>It is written in <a href="http://coffeescript.org/">coffescript</a> and ran with nodejs.</p>

<h2>Hubot setup</h2>

<p>In order to ease this process, we are going to setup and deploy it with docker. Following Dockerfile allowed me to run and test Hubot.</p>

<figure class='code'><figcaption><span>hubot_dockerfile</span><a href='https://gist.github.com/jancorg/2d14912f35f756b97912/'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>FROM dockerfile/nodejs
</span><span class='line'>MAINTAINER  Marvin
</span><span class='line'>
</span><span class='line'>WORKDIR /root
</span><span class='line'>RUN npm install -g yo generator-hubot
</span><span class='line'>
</span><span class='line'>RUN useradd -ms /bin/bash marvin
</span><span class='line'>ENV HOME /home/marvin
</span><span class='line'># variables needed by hubot scripts
</span><span class='line'>ADD env-vars.sh /home/marvin/.profile
</span><span class='line'>RUN chown marvin /home/marvin/.profile
</span><span class='line'>
</span><span class='line'>USER marvin
</span><span class='line'>WORDIR /home/marvin
</span><span class='line'>RUN echo n | yo hubot --defaults
</span><span class='line'>RUN npm install hubot-slack hubot-scripts githubot --save
</span><span class='line'>
</span><span class='line'># enable plugins
</span><span class='line'>RUN echo [ \&#39;github-merge.coffee\&#39; ] &gt; hubot-scripts.json
</span><span class='line'>
</span><span class='line'>CMD [&quot;/home/marvin/bin/hubot&quot;, &quot;--name&quot;, &quot;marvin&quot;]
</span><span class='line'>
</span><span class='line'>EXPOSE 8080
</span></code></pre></td></tr></table></div></figure>


<p>Build an image with <code>docker build -t cname/hubot .</code> or just use the commands for testing it. Nodejs setup instructions can be found on <a href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager">joyent&rsquo;s nodejs repo</a></p>

<p>This also installs <a href="https://github.com/slackhq/hubot-slack">slack adapter</a>, <a href="https://github.com/github/hubot-scripts">hubot-scripts</a> and <a href="https://github.com/iangreenleaf/githubot">githubot</a> npm packages, hence you can figure out how next steps will be.</p>

<p>Let me introduce you to Marvin, my hubot instance, named like Hitchhicker&rsquo;s guide to galaxy assistant robot.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>                 _____________________________
</span><span class='line'>                /                             \
</span><span class='line'>   //\              |      Extracting input for    |
</span><span class='line'>  ////\    _____    |   self-replication process   |
</span><span class='line'> //////\  /_____\   \                             /
</span><span class='line'> ======= |[^_/\_]|   /----------------------------
</span><span class='line'>  |   | _|___@@__|__
</span><span class='line'>  +===+/  ///     \_\
</span><span class='line'>   | |_\ /// HUBOT/\\
</span><span class='line'>   |___/\//      /  \\
</span><span class='line'>     \      /   +---+
</span><span class='line'>      \____/    |   |
</span><span class='line'>       | //|    +===+
</span><span class='line'>        \//      |xx|
</span><span class='line'>
</span><span class='line'>marvin&gt; marvin: the rules
</span><span class='line'>1. A robot may not injure a human being or, through inaction, allow a human being to come to harm.
</span><span class='line'>2. A robot must obey any orders given to it by human beings, except where such orders would conflict with the First Law.
</span><span class='line'>3. A robot must protect its own existence as long as such protection does not conflict with the First or Second Law.
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/github/janky">Janky</a> is a hithub project that implements CI on top Jenkins and Hubot. Chatops term is used to refer chat based deployments and monitoring.</p>

<h2>Github integration</h2>

<p>One of the things I found interesting using hubot for is easy merging and deploy process.
In this article I am just going to treat merging as an example, but concepts shown here could be easily used for integrating it with jenkins or any other tools.</p>

<p>We can find some git related scripts under scripts folder in <a href="https://github.com/github/hubot-scripts">hubot-scripts</a> github project.
This time I have tested <a href="https://github.com/github/hubot-scripts/blob/master/src/scripts/github-merge.coffee">github-merge.coffee</a> plugin. It uses <a href="https://github.com/iangreenleaf/githubot">githubot</a> project for github API access.</p>

<p>We need to set some variables in order this to work. They are made available to hubot as environment variables, so you can set them on <code>env-vars.sh</code> script mentioned in Dockerfile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">HUBOT_GITHUB_TOKEN</span><span class="o">=</span><span class="nv">$token</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_GITHUB_API_VERSION</span><span class="o">=</span><span class="nv">$api_version</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_GITHUB_USER</span><span class="o">=</span><span class="nv">$gh_user</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_GITHUB_API</span><span class="o">=</span><span class="nv">$gh_url</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_CONCURRENT_REQUESTS</span><span class="o">=</span><span class="nv">$req_limit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enabling a plugin is as easy as adding it to <code>hubot-scripts.json</code> or <code>external-scripts.json</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span> <span class="err">&#39;github-merge.coffee&#39;</span> <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Once configured we can check if plugin was loaded sucessfuly and works properly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>marvin&gt; marvin help
</span><span class='line'>[...]
</span><span class='line'>marvin merge project_name/&lt;head&gt; into &lt;base&gt; - merges the selected branches or SHA commits
</span><span class='line'>[...]
</span><span class='line'>marvin&gt; marvin merge nevermind/PXTRM-test-switch-bug into develop
</span><span class='line'>marvin&gt; Merge PXTRM-test-switch-bug into develop
</span><span class='line'>marvin&gt; marvin merge nevermind/PXTRM-merge-conflict-on-purpose into develop
</span><span class='line'>marvin&gt; [Fri Jan 02 2015 17:03:46 GMT+0000 (UTC)] ERROR 409 Merge conflict
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/2015-01-02-hubot/hubot_merged_branch.png" alt="hubot_merged_branch" /></p>

<p>It seems to work, and since it is using <a href="https://developer.github.com/v3/repos/merging/">github merge API</a> we are not messing any branch up.</p>

<h2>Slack integration</h2>

<p>I have chosen slack as default adapter since it is chat tool we are using at office. Hubots default one is <a href="https://github.com/github/hubot/tree/master/src/adapters">campfire</a>.</p>

<p>An organization, if you already don&rsquo;t have one, needs to be created on slack. You can do it on sign up process.
When this is done, just configure integrations and look for hubot there. You will get a token and even you can set a custom avatar for you shinny bot.
Make this token availabe as environment varaible, and&hellip; that&rsquo;s it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">HUBOT_SLACK_TOKEN</span><span class="o">=</span><span class="nv">$slack_token</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both processes are really straighforward.</p>

<p>Let&rsquo;s see the results.</p>

<p><img src="/images/2015-01-02-hubot/hubot_joins_channel.png" alt="joins_channel" /></p>

<p><img src="/images/2015-01-02-hubot/hubot_merge_and_plugin_example.png" alt="hubot_merge_and_plugin_example" /></p>

<p>Enjoy your bot!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/01/linux-kernel-capabilities/">Linux Kernel Capabilities</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-01T20:57:16+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>8:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Capabilities were created as an alternative to classical two level privilege system: root and user. They split a root acount into their privileges. This way, linux kernel allows a process to perform certain root tipical tasks without giving a process full root privileges.</p>

<p>A process or a file, can be granted with a given capability. Each capability is independent from each other.</p>

<p>For instance, a user process with just <code>CAP_NET_BIND_SERVICE</code> capability can open ports bellow 1024, however it can not kill any process or use chroot.</p>

<p>All linux kernel capabilities list can be found on <a href="http://linux.die.net/man/7/capabilities">man pages</a> as well as <a href="https://github.com/torvalds/linux/blob/9a3c4145af32125c5ee39c0272662b47307a8323/include/uapi/linux/capability.h">code</a>.</p>

<p>Instead of checking effective UID of user, modern kernels checks for capabilities, so they allow the privileged operation if capability bit is set in the effective set.</p>

<figure class='code'><figcaption><span>init_process_privileges</span><a href='https://github.com/torvalds/linux/blob/9a3c4145af32125c5ee39c0272662b47307a8323/kernel/cred.c'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">cred</span> <span class="n">init_cred</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">.</span><span class="n">usage</span>                  <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS</span>
</span><span class='line'>  <span class="p">.</span><span class="n">subscribers</span>            <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span><span class='line'>  <span class="p">.</span><span class="n">magic</span>                  <span class="o">=</span> <span class="n">CRED_MAGIC</span><span class="p">,</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">.</span><span class="n">uid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">gid</span>                    <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">suid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">sgid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">euid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">egid</span>                   <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">fsuid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_UID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">fsgid</span>                  <span class="o">=</span> <span class="n">GLOBAL_ROOT_GID</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">securebits</span>             <span class="o">=</span> <span class="n">SECUREBITS_DEFAULT</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">cap_inheritable</span>        <span class="o">=</span> <span class="n">CAP_EMPTY_SET</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">cap_permitted</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">cap_effective</span>          <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">cap_bset</span>               <span class="o">=</span> <span class="n">CAP_FULL_SET</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">user</span>                   <span class="o">=</span> <span class="n">INIT_USER</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">user_ns</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_user_ns</span><span class="p">,</span>
</span><span class='line'>  <span class="p">.</span><span class="n">group_info</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_groups</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="p">}</span> <span class="kt">kernel_cap_t</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are four sets of capabilities:</p>

<ul>
<li><strong>effective</strong>: capabilities that a process is allowed.</li>
<li><strong>permitted</strong>: capabilities that a process is permited. This allows to enable, disable or drop capabilities.</li>
<li><strong>inheritable</strong>: capabilities that a process can give to another process called, for instance, by calling <code>exec()</code> system call.</li>
<li><strong>bounding set</strong>: Limit from capabilities can not be grown. They just can be dropped.</li>
</ul>


<p>Credentials, therefore, are mostly a set of uids/guis, management flags, capabilities, namaspaces and cgroups.</p>

<p>As formerly happened with UID, GID and mode, capabilities are also part of VFS. They are called File Capabilities. They are store in <code>f_cred</code> struct.</p>

<figure class='code'><figcaption><span>file_struct</span><a href='https://github.com/torvalds/linux/blob/603ba7e41bf5d405aba22294af5d075d8898176d/include/linux/fs.h'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">file</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">union</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">llist_node</span> <span class="n">fu_llist</span><span class="p">;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">rcu_head</span>   <span class="n">fu_rcuhead</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">f_u</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">path</span>                     <span class="n">f_path</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">inode</span>                    <span class="o">*</span><span class="n">f_inode</span><span class="p">;</span>    <span class="cm">/* cached value */</span>
</span><span class='line'>  <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span>   <span class="o">*</span><span class="n">f_op</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * Protects f_ep_links, f_flags.</span>
</span><span class='line'><span class="cm">  * Must not be taken from IRQ context.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kt">spinlock_t</span>              <span class="n">f_lock</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">atomic_long_t</span>           <span class="n">f_count</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">f_flags</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">fmode_t</span>                 <span class="n">f_mode</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">mutex</span>            <span class="n">f_pos_lock</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">loff_t</span>                  <span class="n">f_pos</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">fown_struct</span>      <span class="n">f_owner</span><span class="p">;</span>
</span><span class='line'>  <span class="k">const</span> <span class="k">struct</span> <span class="n">cred</span>       <span class="o">*</span><span class="n">f_cred</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">file_ra_state</span>    <span class="n">f_ra</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">u64</span>                     <span class="n">f_version</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef CONFIG_SECURITY</span>
</span><span class='line'>  <span class="kt">void</span>                    <span class="o">*</span><span class="n">f_security</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="cm">/* needed for tty driver, and maybe others */</span>
</span><span class='line'>  <span class="kt">void</span>                    <span class="o">*</span><span class="n">private_data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef CONFIG_EPOLL</span>
</span><span class='line'>  <span class="cm">/* Used by fs/eventpoll.c to link all the hooks to this file */</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">list_head</span>        <span class="n">f_ep_links</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">list_head</span>        <span class="n">f_tfile_llink</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_EPOLL */</span><span class="cp"></span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">address_space</span>    <span class="o">*</span><span class="n">f_mapping</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>  <span class="cm">/* lest something weird decides that 2 is OK */</span>
</span></code></pre></td></tr></table></div></figure>


<p>This way, we can, for example ping some host on the internet using <code>CAP_NET_RAW</code> capability.</p>

<p>Following is an example of setting a capability in command line interface.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># setcap cap_dac_override,cap_sys_tty_config+ep /usr/bin/beep</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/21/docker-code-curiosities/">Docker Code Curiosities</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/05/linux-kernel-namespaces-pt-i/">Linux Kernel Namespaces Pt I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/03/libcontainer-overview/">LibContainer Overview</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/02/hubot-a-bot-for-automating-daily-tasks-or-anything-else/">Hubot: A Bot for Automating Daily Tasks or Anything Else</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/01/linux-kernel-capabilities/">Linux Kernel Capabilities</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - jancorg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jancorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
